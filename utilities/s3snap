#!/bin/bash
# s3snap.sh
# Variables
CURRENT_DIR="$( cd "$( dirname "${0}" )" && pwd )" # Obtener el directorio actual
PARENT_DIR="$( dirname "$CURRENT_DIR" )" # Get the parent directory of the current directory
AWS_CONFIG="$PARENT_DIR/AWS/aws_config.sh"
SOURCE_DIR="/home/ubuntu/scripts" # Obtener el directorio padre del script
BUCKET="s3://ec2-safety-vault" # Bucket de Amazon S3 para el respaldo
BACKUP_FILE="backup_$SOURCE_DIR_$(date +%Y%m%d_%H%M%S).tar.gz" # Nombre del archivo de respaldo
LOG_DIR="/var/log/s3snap"
LOG_FILE="$LOG_DIR/backup_log_$(date +%Y%m%d).txt" # Nombre del archivo de registro
BACKUP_DIR="/var/s3snap"

function get_instance_id() {
  instance_id=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
  if [[ -n "$instance_id" ]]; then
    echo "ID de instancia EC2: $instance_id"
  else
    echo "No se pudo obtener el ID de instancia EC2."
  fi
  BACKUP_PATH="$BACKUP_DIR/$instance_id" # Directorio temporal para archivo comprimido
}

# Función para comprobar si la ruta de respaldo está montada
function check_mount() {
    # Comprobar si la ruta de respaldo está montada
    echo "Comprobando si la ruta de respaldo está montada..."
    mount_point=$(df --output=target "$BACKUP_DIR" | tail -n 1)
    if [ "$mount_point" != "$BACKUP_DIR" ]; then
        echo "La ruta de respaldo '$BACKUP_DIR' no está montada."
        map_s3
    else
        echo "La ruta de respaldo '$BACKUP_DIR' está montada."
    fi
}
# Función para verificar la existencia del directorio temporal para archivo comprimido
function check_log_dir() {
    # verificar la existencia del directorio temporal
    echo "Verificando la existencia del directorio log..."
    if [ -d "$LOG_DIR" ]; then
        echo "El directorio log '$LOG_DIR' existe."
    else
        echo "ERROR: El directorio log '$LOG_DIR' no existe."
        echo "Creando el directorio log '$LOG_DIR'."
        sudo mkdir -p "$LOG_DIR" 
        sudo chmod 777 "$LOG_DIR" 
    fi
}
function check_backup_dir() {
    
    # verificar la existencia del directorio temporal
    echo "Verificando la existencia del directorio temporal..."
    if [ -d "$BACKUP_PATH" ]; then
        echo "El directorio de respaldo '$BACKUP_PATH' existe."
    else
        echo "ERROR: El directorio de respaldo '$BACKUP_PATH' no existe."
        echo "Creando el directorio de respaldo '$BACKUP_PATH'."
        sudo mkdir -p "$BACKUP_PATH" 
    fi
}
# Funcion para limpiar respaldos viejos
function clean_up() {
    # Comprobar si hay archivos en el directorio de respaldo
    echo "Comprobando si hay archivos en el directorio de respaldo..."
    shopt -s nullglob
    files=("$BACKUP_DIR"/*)
    if [ ${#files[@]} -eq 0 ]; then
        echo "ADVERTENCIA: No hay archivos en el directorio de respaldo."
        return
    fi

    # Limpiar respaldos viejos
    echo "Limpiando respaldos viejos..."
    sudo rm -f ${BACKUP_DIR:?}/*
    sleep 5
}
# Funcion para comprimir el directorio de origen en un archivo tar.gz
function compress_source(){
    # comprimir el directorio de origen en un archivo tar.gz
    echo "Comprimiendo el directorio '$SOURCE_DIR' con destino '$BACKUP_PATH'..."
    sudo tar czf "$BACKUP_PATH/$BACKUP_FILE" -C "$SOURCE_DIR" .
    sleep 5
}
# Función para calcular el tamaño total del archivo creado
function calculate_size() {
    # calcular el tamaño total del archivo creado
    echo "Calculando el tamaño total del archivo creado..."
    tamano_total=$(du -sh $BACKUP_PATH/$BACKUP_FILE | awk '{print $1}')  # Obtener el tamaño total en formato legible por humanos
    if [ $? -ne 0 ]; then
        echo "Ha ocurrido un error al calcular el tamaño total del archivo"
        exit 1
    fi
    echo "El tamaño total del archivo creado es: $tamano_total"
}
# Función para mostrar información de la copia de seguridad
function report() {
    # mostrar información de la copia de seguridad
    echo "Mostrando información de la copia de seguridad..."
    echo "Hora de copia de seguridad: $inicio"
    echo "Tiempo transcurrido: $tiempo_transcurrido segundos."
    echo "El tamaño total de la copia de seguridad es: $tamano_total."
    echo "Copia de seguridad realizada con exito..."
    echo "Mostrando información de la copia de seguridad..." | tee -a "$LOG_FILE"
    echo "Hora de copia de seguridad: $inicio" | tee -a "$LOG_FILE"
    echo "Tiempo transcurrido: $tiempo_transcurrido segundos." | tee -a "$LOG_FILE"
    echo "El tamaño total de la copia de seguridad es: $tamano_total." | tee -a "$LOG_FILE"
    echo "Copia de seguridad realizada con éxito..." | tee -a "$LOG_FILE"
    ls "$BACKUP_DIR" | tee -a "$LOG_FILE"
}
# Funcion para copiar el archivo de respaldo a S3 utilizando awscli
function s3_sync() {
    echo "Sincronizando con S3..."
    sudo aws s3 sync "$BACKUP_PATH" "$BUCKET"
    echo "Copia de seguridad realizada con exito..."
}
# Función para agregar una entrada al crontab para automatizar la ejecución del script tras cada reinicio
function add_cron_entry() {
  local cron_entry="0 0 * * * s3snap"
  
  # agregar una entrada al crontab para automatizar la ejecución del script tras cada reinicio
  echo "Agregando una entrada al crontab para automatizar la ejecución del script tras cada reinicio..."
  
  # Verificar si la entrada ya existe en el crontab
  if sudo crontab -l | grep -q "$cron_entry"; then
    echo "La entrada ya existe en el crontab. No se realizará ninguna modificación."
  else
    # Agregar la entrada al crontab utilizando echo y redirección de entrada
    echo "$(sudo crontab -l 2>/dev/null; echo "$cron_entry")" | sudo crontab -
    echo "Se ha agregado la entrada al crontab para ejecutar el script tras cada reinicio."
  fi
}

# Funcion principal
function s3snap() {
    get_instance_id
    check_mount
    check_log_dir
    check_backup_dir
    #clean_up
    # Inicio del programa
    inicio=$(date +%s)  # Tomar la hora de inicio del respaldo
    compress_source
    calculate_size
    s3_sync
    # Calcular el tiempo transcurrido
    fin=$(date +%s)  # Tomar la hora de fin del respaldo
    tiempo_transcurrido=$((fin - inicio))  # Calcular el tiempo transcurrido en segundos
    # Fin
    echo "Registrando información de la copia de seguridad en $LOG_FILE..."
    report
    add_cron_entry
}
# Llamar a la funcion principal
s3snap
